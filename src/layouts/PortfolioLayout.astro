---
import SEOLayout from './SEOLayout.astro';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
import { Image } from 'astro:assets';

interface Props {
  title: string;
  description: string;
  keywords: string[];
  publishDate: Date;
  author?: string;
  client?: string;
  projectDate?: Date;
  coverImage?: ImageMetadata;
  coverImageAlt?: string;
  gallery?: Array<{
    src: ImageMetadata;
    alt: string;
    caption?: string;
  }>;
  category?: string;
  tags?: string[];
  projectUrl?: string;
  ogImage?: string;
  canonical?: string;
  noindex?: boolean;
  nofollow?: boolean;
}

const {
  title,
  description,
  keywords,
  publishDate,
  author = 'CMDX',
  client,
  projectDate,
  coverImage,
  coverImageAlt,
  gallery = [],
  category,
  tags = [],
  projectUrl,
  ogImage,
  canonical,
  noindex = false,
  nofollow = false,
} = Astro.props;

const formattedProjectDate = projectDate?.toLocaleDateString('pl-PL', {
  year: 'numeric',
  month: 'long',
});

// Generowanie szczegółowego schema.org
const currentUrl = Astro.url.href;
const siteUrl = Astro.site?.toString() || 'https://cmdx.pl';

// Pełny URL do obrazu
const imageUrl = ogImage
  ? (ogImage.startsWith('http') ? ogImage : `${siteUrl}${ogImage}`)
  : coverImage
    ? `${siteUrl}${coverImage.src}`
    : `${siteUrl}/og-image.jpg`;

// Szczegółowe schema dla projektu portfolio
const portfolioSchema = {
  "@context": "https://schema.org",
  "@graph": [
    // 1. CreativeWork - główny typ dla projektu kreatywnego
    {
      "@type": "CreativeWork",
      "@id": `${currentUrl}#creativework`,
      "name": title,
      "headline": title,
      "description": description,
      "image": {
        "@type": "ImageObject",
        "url": imageUrl,
        "width": 1200,
        "height": 630
      },
      "creator": {
        "@type": "Organization",
        "@id": `${siteUrl}#organization`,
        "name": "CMDX",
        "url": siteUrl,
        "logo": {
          "@type": "ImageObject",
          "url": `${siteUrl}/logo.png`
        }
      },
      "dateCreated": projectDate?.toISOString() || publishDate.toISOString(),
      "datePublished": publishDate.toISOString(),
      "inLanguage": "pl-PL",
      "keywords": keywords.join(', '),
      "about": {
        "@type": "Thing",
        "name": category || "Design & Branding"
      },
      "workExample": gallery.map((item, index) => ({
        "@type": "ImageObject",
        "@id": `${currentUrl}#image-${index}`,
        "url": `${siteUrl}${item.src.src}`,
        "name": item.alt,
        "description": item.caption || item.alt,
        "contentUrl": `${siteUrl}${item.src.src}`,
        "encodingFormat": "image/jpeg"
      })),
      "audience": {
        "@type": "Audience",
        "audienceType": "Business professionals, Marketing teams, Property developers"
      }
    },
    // 2. Article - dla lepszego indeksowania jako artykuł portfolio
    {
      "@type": "Article",
      "@id": `${currentUrl}#article`,
      "headline": title,
      "description": description,
      "image": imageUrl,
      "datePublished": publishDate.toISOString(),
      "dateModified": publishDate.toISOString(),
      "author": {
        "@type": "Organization",
        "@id": `${siteUrl}#organization`
      },
      "publisher": {
        "@type": "Organization",
        "@id": `${siteUrl}#organization`
      },
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": currentUrl
      },
      "articleSection": category || "Portfolio",
      "keywords": keywords.join(', '),
      "inLanguage": "pl-PL"
    },
    // 3. Service - usługa brandingowa/projektowa
    {
      "@type": "Service",
      "@id": `${currentUrl}#service`,
      "serviceType": category || "Branding & Visual Identity Design",
      "name": title,
      "description": description,
      "provider": {
        "@type": "Organization",
        "@id": `${siteUrl}#organization`
      },
      "offers": {
        "@type": "Offer",
        "availability": "https://schema.org/InStock",
        "priceSpecification": {
          "@type": "PriceSpecification",
          "priceCurrency": "PLN"
        }
      },
      "areaServed": {
        "@type": "Country",
        "name": "Poland"
      },
      "hasOfferCatalog": {
        "@type": "OfferCatalog",
        "name": "Design Services",
        "itemListElement": tags.map((tag, index) => ({
          "@type": "Offer",
          "position": index + 1,
          "itemOffered": {
            "@type": "Service",
            "name": tag,
            "serviceType": tag
          }
        }))
      }
    },
    // 4. Product - dla projektów jako produkt końcowy
    {
      "@type": "Product",
      "@id": `${currentUrl}#product`,
      "name": title,
      "description": description,
      "image": imageUrl,
      "brand": {
        "@type": "Brand",
        "name": client || "CMDX"
      },
      "category": category || "Design Services",
      "offers": {
        "@type": "Offer",
        "availability": "https://schema.org/InStock",
        "seller": {
          "@type": "Organization",
          "@id": `${siteUrl}#organization`
        }
      }
    },
    // 5. BreadcrumbList - ścieżka nawigacji
    {
      "@type": "BreadcrumbList",
      "@id": `${currentUrl}#breadcrumb`,
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Strona główna",
          "item": siteUrl
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Portfolio",
          "item": `${siteUrl}/portfolio`
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": title,
          "item": currentUrl
        }
      ]
    },
    // 6. WebPage - strona projektu
    {
      "@type": "WebPage",
      "@id": currentUrl,
      "url": currentUrl,
      "name": title,
      "description": description,
      "isPartOf": {
        "@type": "WebSite",
        "@id": `${siteUrl}#website`,
        "url": siteUrl,
        "name": "CMDX - Digital Design & Development"
      },
      "primaryImageOfPage": {
        "@type": "ImageObject",
        "@id": `${currentUrl}#primaryimage`,
        "url": imageUrl
      },
      "datePublished": publishDate.toISOString(),
      "dateModified": publishDate.toISOString(),
      "inLanguage": "pl-PL",
      "potentialAction": {
        "@type": "ReadAction",
        "target": [currentUrl]
      }
    },
    // 7. ImageGallery - galeria obrazów
    {
      "@type": "ImageGallery",
      "@id": `${currentUrl}#gallery`,
      "name": `${title} - Galeria`,
      "description": `Galeria wizualizacji projektu ${title}`,
      "image": [imageUrl, ...gallery.map(item => `${siteUrl}${item.src.src}`)],
      "author": {
        "@type": "Organization",
        "@id": `${siteUrl}#organization`
      }
    },
    // 8. Organization - firma CMDX
    {
      "@type": "Organization",
      "@id": `${siteUrl}#organization`,
      "name": "CMDX",
      "alternateName": "CMDX Design Studio",
      "url": siteUrl,
      "logo": {
        "@type": "ImageObject",
        "url": `${siteUrl}/logo.png`,
        "width": 250,
        "height": 60
      },
      "description": "Studio projektowe specjalizujące się w brandingu, identyfikacji wizualnej i web developmencie",
      "address": {
        "@type": "PostalAddress",
        "addressCountry": "PL"
      },
      "contactPoint": {
        "@type": "ContactPoint",
        "contactType": "customer service",
        "availableLanguage": ["Polish", "English"]
      },
      "sameAs": []
    }
  ]
};
---

<SEOLayout
  title={title}
  description={description}
  keywords={keywords}
  ogImage={ogImage}
  canonical={canonical}
  noindex={noindex}
  nofollow={nofollow}
  author={author}
  publishDate={publishDate}
  disableBaseSchema={true}
>
  <!-- Szczegółowe Schema.org JSON-LD -->
  <script type="application/ld+json" slot="schema" set:html={JSON.stringify(portfolioSchema)} />

  <Nav />

  <article class="portfolio-item">
    <header class="project-header">
      <div class="breadcrumb">
        <a href="/">Strona główna</a> / <a href="/portfolio">Portfolio</a>
      </div>

      <h1>{title}</h1>

      <div class="project-meta">
        {client && (
          <div class="meta-item">
            <strong>Klient:</strong> {client}
          </div>
        )}
        {formattedProjectDate && (
          <div class="meta-item">
            <strong>Data:</strong> {formattedProjectDate}
          </div>
        )}
        {category && (
          <div class="meta-item">
            <strong>Kategoria:</strong> <span class="category">{category}</span>
          </div>
        )}
        {projectUrl && (
          <div class="meta-item">
            <strong>Link:</strong> <a href={projectUrl} target="_blank" rel="noopener noreferrer">Zobacz projekt →</a>
          </div>
        )}
      </div>

      
    </header>

    <div class="project-content">
      <slot />
    </div>

    
 

    {tags.length > 0 && (
      <footer class="project-footer">
        <div class="tags">
          <strong>Umiejętności:</strong>
          {tags.map((tag) => (
            <span class="tag">{tag}</span>
          ))}
        </div>
      </footer>
    )}

    <div class="back-link">
      <a href="/portfolio">← Powrót do portfolio</a>
    </div>
  </article>

  <Footer />
</SEOLayout>

<script>
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  // Rejestracja pluginu
  gsap.registerPlugin(ScrollTrigger);

  // Funkcja inicjalizująca animacje
  function initAnimations() {
    // Animacja nagłówka - fade in z góry
    gsap.from('.project-header h1', {
      opacity: 0,
      y: -50,
      duration: 1,
      ease: 'power3.out',
      delay: 0.2
    });

    // Animacja breadcrumb
    gsap.from('.breadcrumb', {
      opacity: 0,
      y: -20,
      duration: 0.8,
      ease: 'power2.out'
    });

    // Animacja meta informacji
    gsap.from('.meta-item', {
      opacity: 0,
      y: 20,
      duration: 0.6,
      stagger: 0.1,
      ease: 'power2.out',
      delay: 0.3
    });

    // Animacja bento-grid items ze ScrollTrigger
    const bentoItems = gsap.utils.toArray('.bento-item, .bento-item-color');

    bentoItems.forEach((item: any, index: number) => {
      // Różne efekty dla różnych typów elementów
      const isImage = item.classList.contains('bento-image');
      const isOrange = item.classList.contains('bento-orange');

      if (isImage) {
        // Obrazy - scale + fade
        gsap.from(item, {
          scrollTrigger: {
            trigger: item,
            start: 'top 85%',
            end: 'top 20%',
            toggleActions: 'play none none reverse'
          },
          scale: 0.9,
          opacity: 0,
          duration: 0.8,
          ease: 'power2.out'
        });
      } else if (isOrange) {
        // Pomarańczowy blok z logo - rotate + fade
        gsap.from(item, {
          scrollTrigger: {
            trigger: item,
            start: 'top 85%',
            toggleActions: 'play none none reverse'
          },
          scale: 0.8,
          rotation: -5,
          opacity: 0,
          duration: 1,
          ease: 'back.out(1.2)'
        });
      } else {
        // Standardowe bloki tekstowe - slide from left/right
        const direction = index % 2 === 0 ? -50 : 50;

        gsap.from(item, {
          scrollTrigger: {
            trigger: item,
            start: 'top 85%',
            toggleActions: 'play none none reverse'
          },
          x: direction,
          opacity: 0,
          duration: 0.8,
          ease: 'power2.out'
        });
      }
    });

    // Animacja palety kolorów - każdy kolor osobno
    gsap.from('.bento-color', {
      scrollTrigger: {
        trigger: '.bento-palette',
        start: 'top 85%',
        toggleActions: 'play none none reverse'
      },
      scaleY: 0,
      opacity: 0,
      duration: 0.6,
      stagger: 0.1,
      ease: 'power2.out',
      transformOrigin: 'bottom center'
    });

    // Animacja tagów w footerze
    gsap.from('.tag', {
      scrollTrigger: {
        trigger: '.tags',
        start: 'top 90%',
        toggleActions: 'play none none reverse'
      },
      scale: 0,
      opacity: 0,
      duration: 0.5,
      stagger: 0.08,
      ease: 'back.out(1.5)'
    });

    // Parallax effect dla dużych obrazów
    const largeImages = document.querySelectorAll('.bento-row-3 .bento-img, .bento-row-4 .bento-img');

    largeImages.forEach((img: any) => {
      gsap.to(img, {
        scrollTrigger: {
          trigger: img,
          start: 'top bottom',
          end: 'bottom top',
          scrub: 1
        },
        y: -50,
        ease: 'none'
      });
    });

    // Hover effect na bento-items (tylko desktop)
    if (window.innerWidth > 768) {
      bentoItems.forEach((item: any) => {
        item.addEventListener('mouseenter', () => {
          gsap.to(item, {
            scale: 1.02,
            duration: 0.3,
            ease: 'power2.out'
          });
        });

        item.addEventListener('mouseleave', () => {
          gsap.to(item, {
            scale: 1,
            duration: 0.3,
            ease: 'power2.out'
          });
        });
      });
    }
  }

  // Inicjalizacja po załadowaniu DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAnimations);
  } else {
    initAnimations();
  }

  // Reinicjalizacja po nawigacji z View Transitions
  document.addEventListener('astro:page-load', () => {
    ScrollTrigger.refresh();
    initAnimations();
  });

  // Cleanup przed zmianą strony
  document.addEventListener('astro:before-preparation', () => {
    ScrollTrigger.getAll().forEach(trigger => trigger.kill());
  });
</script>

<style>
  .portfolio-item {
    max-width: 1500px;
    margin: 0 auto;
    padding: 4rem 2rem;
    min-height: calc(100vh - 64px);
  }

  .breadcrumb {
    font-size: 0.875rem;
    color: #86868B;
    margin-bottom: 2rem;
    font-weight: 400;
  }

  .breadcrumb a {
    color: #1D1D1F;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .breadcrumb a:hover {
    color: #0066CC;
  }

  .project-header {
    margin-bottom: 4rem;
  }

  .project-header h1 {
    font-size: 3.5rem;
    font-weight: 700;
    line-height: 1.1;
    margin-bottom: 2rem;
    color: #1D1D1F;
    letter-spacing: -0.02em;
  }

  .project-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 2rem;


  }

  .meta-item {
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .meta-item strong {
    color: #86868B;
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .meta-item a {
    color: #0066CC;
    text-decoration: none;
    font-weight: 500;
    transition: opacity 0.2s ease;
  }

  .meta-item a:hover {
    opacity: 0.7;
  }

  .category {
    background: #F5F5F7;
    padding: 0.4rem 1rem;
    border-radius: 50px;
    font-weight: 600;
    color: #1D1D1F;
    border: 1px solid #E5E5E7;
  }

  .cover-image {
    margin-top: 3rem;
    border-radius: 50px;
    overflow: hidden;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
  }

  .cover-image img {
    width: 100%;
    height: auto;
    display: block;
  }

  .project-content {
    font-size: 1.125rem;
    line-height: 1.7;
    margin-bottom: 5rem;
    color: #1D1D1F;
  }

  .project-content :global(h2) {
    font-size: 2.5rem;
    font-weight: 700;
    margin-top: 0rem;
    margin-bottom: 0rem;
    color: #1D1D1F;
    letter-spacing: -0.02em;
  }

  .project-content :global(h3) {
    font-size: 1.75rem;
    font-weight: 600;
    margin-top: 3rem;
    margin-bottom: 1rem;
    color: #1D1D1F;
    letter-spacing: -0.01em;
  }

  .project-content :global(p) {
    margin-bottom: 1.5rem;
    color: #1D1D1F;
  }

  .project-content :global(img) {
    border-radius: 0px;
    margin: 0rem 0;
    box-shadow: 0;
  }

  .gallery {
    margin: 5rem 0;
  }

  .gallery h2 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0rem;
    color: #1D1D1F;
    letter-spacing: -0.02em;
  }

  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 2rem;
  }

  .gallery-item {
    margin: 0;
    border-radius: 50px;
    overflow: hidden;
    background: white;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .gallery-item:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
  }

  .gallery-item img {
    width: 100%;
    height: auto;
    display: block;
  }

  .gallery-item figcaption {
    padding: 1.25rem;
    background: white;
    font-size: 0.9rem;
    color: #86868B;
    text-align: center;
    font-weight: 500;
  }

  .project-footer {
    margin-top: 4rem;
    padding-top: 3rem;
    border-top: 1px solid #E5E5E7;
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
  }

  .tags strong {
    color: #86868B;
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-right: 0.5rem;
  }

  .tag {
    background: white;
    padding: 0.5rem 1.25rem;
    border-radius: 50px;
    font-size: 0.9rem;
    color: #1D1D1F;
    border: 1px solid #E5E5E7;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .tag:hover {
    background: #F5F5F7;
    border-color: #1D1D1F;
  }

  .back-link {
    margin-top: 4rem;
    padding-top: 3rem;
    border-top: 1px solid #E5E5E7;
  }

  .back-link a {
    color: #0066CC;
    text-decoration: none;
    font-weight: 600;
    font-size: 1rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: opacity 0.2s ease;
  }

  .back-link a:hover {
    opacity: 0.7;
  }

  @media (max-width: 1024px) {
    .portfolio-item {
      padding: 3rem 1.5rem;
    }

    .project-header h1 {
      font-size: 2.5rem;
    }

    .project-content :global(h2) {
      font-size: 2rem;
    }

    .project-content :global(h3) {
      font-size: 1.5rem;
    }
  }

  @media (max-width: 768px) {
    .portfolio-item {
      padding: 2rem 1rem;
    }

    .project-header h1 {
      font-size: 2rem;
    }

    .project-meta {
      flex-direction: column;
      gap: 1rem;
      padding: 1.5rem;
    }

    .project-content {
      font-size: 1rem;
    }

    .project-content :global(h2) {
      font-size: 1.75rem;
      margin-top: 0;
    }

    .project-content :global(h3) {
      font-size: 1.25rem;
      margin-top: 2rem;
    }

    .gallery-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .gallery h2 {
      font-size: 1.75rem;
    }
  }
</style>
